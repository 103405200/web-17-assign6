<!DOCTYPE html>
<html lang="en">

  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./style.css">
  </head>

  <body >
    <div id="app">

        <nav class="container">

            <p class="pull-left">獨立音樂活動清單</p>
            <div class="pull-right">
                <span class="glyphicon glyphicon-th-large" @click="control.filter = 'all' "></span>
                <span class="glyphicon glyphicon-star"     @click="control.filter = 'star' "></span>
                <span>|</span>
                <span class="glyphicon glyphicon-time"     @click="control.sort   = 'time' "></span>
                <span class="glyphicon glyphicon-tag"      @click="control.sort   = 'price' "></span>

                <input type="text" v-model="control.search">
            </div>
        </nav>

        <main class="container">
            <div class="items">
                <article class="item" v-for="s in current_activities">

                    <header>
                        <h1>{{s.title}}</h1>
                        <div :class="'swipe star ' + (favorate[s.UID] ? 'true':'') " @click="select(s)">
                          <span class="glyphicon glyphicon-star"></span>
                        </div>
                    </header>

                    <dl>
                        <dt>時間</dt>
                        <dd>{{s.showInfo[0].time}}</dd>
                    </dl>

                    <dl>
                        <dt>價錢</dt>
                        <dd>{{s.showInfo[0].price.substring(0,10)}}</dd>
                    </dl>

                    <dl>
                        <dt>地點</dt>
                        <dd>{{s.showInfo[0].location}}</dd>
                    </dl>

                </article>
            </div
            <footer class="container">
                <span v-if="current_activities && current_activities.length ">{{total}}</span >
                <span v-else>目前還沒有資料。</span >

            </footer>
        </main>
    </div>



    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.2.6/vue.js"></script>
    <script>

        $.getJSON("./show.json",function(json){
            console.log(json)
            json.forEach(function(s){
                s.selected = false
            })
            window.app = new Vue({
                el : "#app",
                data : {
                    activities : json ,
                    favorate : {},
                    control : {
                        search : "" ,
                        sort : "" ,
                        filter : "" ,
                    }
                },
                methods : {
                    select : function (s){
                        this.$set(this.favorate, s.UID , this.favorate[s.UID] ?  false : true )
                        console.log(this.favorate)
                    }
                },
                computed : {
                    total : function (){
                        return this.current_activities.reduce(function (v,s){
                            var p = parseInt(s.showInfo[0].price)
                            console.log(p)
                            return v + (!isNaN(p) ? p : 0 )
                        },0)
                    },
                    current_activities : function (){
                        var vm = this

                        var current = []

                        // filter
                        switch (vm.control.filter){
                            case "all" :
                                current = vm.activities
                                break
                            case "star" :
                                current = vm.activities.filter(function(s){
                                    return vm.favorate[s.UID]
                                })
                        }
                        // search
                        if (vm.control.search && vm.control.search.length > 0 ){
                            current = current.filter(function(s){
                                // console.log("s.title",s.title,vm.control.search,s.title.toLowerCase().indexOf(vm.control.search))
                                return s.title.toLowerCase().indexOf(vm.control.search.toLowerCase()) > -1
                            })
                        }
                        // sort ?
                        switch (vm.control.sort){
                            case "time" :
                                current = current.sort(function(a,b){
                                    return b.showInfo[0].time.localeCompare(a.showInfo[0].time )
                                })
                                break ;
                            case "price" :
                                current = current.sort(function(b,a){
                                    return b.showInfo[0].time.localeCompare(a.showInfo[0].time )
                                })
                                break ;
                            default : break ;
                        }
                        return current
                    }
                }
            })
        })
    </script>

  </body>
</html>
